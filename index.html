<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mira la luna — Debug</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;background:
      linear-gradient(rgba(0,0,0,0.36),rgba(0,0,0,0.36)),
      url('https://github.com/user-attachments/assets/ee35b9f1-ecec-4612-9a84-91478130cd2a') center/cover no-repeat;
      color:white;font-family:Arial, sans-serif;padding:20px}
    .contenedor{position:fixed;right:18px;top:18px;width:300px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.6)}
    .pw-input{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
    input[type="password"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#fff}
    button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    #pwButton{background:#6bd3a8;color:#041014}
    #pwStatus{min-height:18px;margin-top:8px}
    #debugBox{margin-top:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);color:#ffd9e8;font-size:13px;min-height:24px}
  </style>
</head>
<body>
  <h1>Viste? al final te gane</h1>
  <div class="contenedor" role="region" aria-label="Acceso a sorpresa">
    <h2>Entrada ultra mega secreta</h2>
    <p>Para ingresár... o ingresá la contraseña</p>

    <div id="qr-preview">QR aqui</div>
    <input id="qrFile" type="file" accept="image/*" />

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="startCamera">Usar camara</button>
      <button id="fake-scan">QR de testeo</button>
    </div>

    <div class="pw-input" style="margin-top:8px">
      <!-- Agrego onclick inline COMO FALLBACK -->
      <input id="pw" type="password" placeholder="Contraseña secreta" aria-label="Contraseña secreta" />
      <button id="pwButton" type="button" onclick="inlinePwHandler()">Ingresar</button>
    </div>

    <div id="pwStatus" aria-live="polite"></div>
    <div id="debugBox">Estado debug: inicializando...</div>
  </div>

  <div id="sorpresa" style="display:none;margin-top:120px;color:#ffd9e8">
    <h3>🎉 Sorpresa desbloqueada</h3>
    <p>Si ves esto, la autenticación funcionó.</p>
  </div>

  <script>
    (function () {
      const SECRET_PASSWORD = 'amor2025';
      const debugBox = () => document.getElementById('debugBox');
      // Handler inline (falla segura si JS está bloqueado? al menos muestra algo)
      window.inlinePwHandler = function () {
        try {
          console.log('inlinePwHandler invoked');
          debugBox().textContent = 'inline handler: clic detectado';
          // delego al mismo flujo
          attemptPasswordCheck();
        } catch (e) {
          console.error('inline handler error', e);
          debugBox().textContent = 'inline handler error: ' + e.message;
        }
      };

      // Comprueba si el DOM ya está listo
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOMContentLoaded');
        debugBox().textContent = 'DOMContentLoaded — inicializando listeners...';

        const pwInput = document.getElementById('pw');
        const pwButton = document.getElementById('pwButton');
        const fakeScanBtn = document.getElementById('fake-scan');
        const qrFile = document.getElementById('qrFile');
        const startCamera = document.getElementById('startCamera');
        const pwStatus = document.getElementById('pwStatus');
        const sorpresa = document.getElementById('sorpresa');

        if (!pwButton) {
          console.warn('No se encontró #pwButton');
          debugBox().textContent = 'ERROR: No se encontró #pwButton';
          return;
        }

        // 1) Listener directo
        pwButton.addEventListener('click', (e) => {
          console.log('Listener directo: click en pwButton');
          debugBox().textContent = 'Listener directo: recibido click';
          attemptPasswordCheck();
        });

        // 2) Listener delegado a nivel documento (fallback si algo captura/stopPropagation)
        document.addEventListener('click', (e) => {
          const t = e.target;
          if (t && (t.id === 'pwButton' || t.closest && t.closest('#pwButton'))) {
            console.log('Listener delegado: click detectado en pwButton');
            debugBox().textContent = 'Listener delegado: recibido click';
            // Nota: no evitamosDefault aqui porque el directo lo hace también
            attemptPasswordCheck();
          }
        });

        // Enter en input
        pwInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            console.log('Enter presionado en input pw');
            debugBox().textContent = 'Enter en input: activando ingreso';
            attemptPasswordCheck();
          }
        });

        // fake scan
        fakeScanBtn.addEventListener('click', () => {
          console.log('fake-scan clicked');
          debugBox().textContent = 'QR de testeo: acceso concedido';
          unlock('QR de testeo');
        });

        // qr file
        qrFile.addEventListener('change', () => {
          if (qrFile.files && qrFile.files.length) {
            debugBox().textContent = 'QR cargado — acceso concedido';
            unlock('QR subido');
          }
        });

        // cámara demo
        startCamera.addEventListener('click', async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            debugBox().textContent = 'Cámara iniciada (demo)';
            stream.getTracks().forEach(t => t.stop());
          } catch (err) {
            debugBox().textContent = 'Error al iniciar cámara';
            console.warn(err);
          }
        });

        // función que valida
        function attemptPasswordCheck() {
          try {
            const val = (pwInput && pwInput.value) ? pwInput.value.trim() : '';
            console.log('attemptPasswordCheck, valor:', val ? '[RELLENO]' : '(vacío)');
            if (!val) {
              pwStatus.textContent = '❗ Escribí la contraseña primero.';
              pwStatus.className = 'status-err';
              debugBox().textContent = 'Intento: campo vacío';
              return;
            }
            if (val === SECRET_PASSWORD) {
              unlock('contraseña');
            } else {
              pwStatus.textContent = '❌ Contraseña incorrecta.';
              pwStatus.className = 'status-err';
              debugBox().textContent = 'Intento: contraseña incorrecta';
            }
          } catch (e) {
            console.error('Error en attemptPasswordCheck', e);
            debugBox().textContent = 'Error: ' + e.message;
          }
        }

        function unlock(source) {
          document.getElementById('sorpresa').style.display = 'block';
          pwStatus.textContent = ✅ Acceso concedido (${source});
          pwStatus.className = 'status-ok';
          debugBox().textContent = 'Acceso concedido: ' + source;
        }

        // Indico que ya quedó todo conectado
        setTimeout(() => { debugBox().textContent = 'Listo — listeners conectados'; }, 350);
      }); // end DOMContentLoaded
    })();
  </script>
</body>
</html>
